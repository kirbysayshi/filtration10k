(function(l){l(function(){function y(a){var b=v();this.setRad(30*b+15);this.ist=a;this.ppos=c.a(0,0,0);this.cpos=c.a(0,0,0);this.acl=c.a(0,0,0);this.cto=[];this.cnes=99*v()+1;this.tto=[];this.pstr=99*b+1}function la(a,b,e){this.rad=2;this.cnes=e;this.ppos=c.cn(a.ppos);this.cpos=c.cn(a.cpos);this.acl=c.cn(a.acl);this.snode=a;this.tnode=b}function Y(){m=[z.width(),z.height(),1E3];dimh=c.sc(m,0.5);A.attr({width:m[0],height:m[1]})}function L(a){return c.a((a[0]-B[0])*o+dimh[0],(a[1]-B[1])*o+dimh[1],0)}
function Z(a){return c.a(a[0]/o+B[0]-dimh[0]/o,a[1]/o+B[1]-dimh[1]/o,0)}function ma(){for(var a=true,b=0;b<j.length;b++)if(j[b].cnes<$)a=false;if(a===true&&M===false){M=true;N.fadeIn();A.fadeTo(300,0.2);C.text("");O[D]={time:+new Date-P,bus:H,ccount:j.length+s.length,tanti:I,rsts:aa};setTimeout(function(){N.fadeOut(function(){M=false;A.fadeTo(300,1);D++;Q()})},5E3)}}function Q(){j=[];s=[];p=[];I=H=0;if(D>=ba.length)ca();else{var a=ba[D];q=a.boosts;J.text("BOOSTS: "+q);C.text("Press the ESC key to stop at any time.");
E.find("h1").text(a.name);E.find("p").text(a.hint);E.fadeIn(400);setTimeout(function(){E.fadeOut(400)},5E3);a.init();P=+new Date}}function ca(){j=[];s=[];p=[];I=H=0;q=5;C.text("");J.text("BOOSTS: "+q);P=+new Date;for(var a=0,b=r(da/4),e;a<b;a++){e=new y(true);sec=c.a(r(m[0]/(b+1)),r(m[1]/(b+1)*v()),0);e.cpos=c.sc(sec,a+1);e.ppos=c.sc(sec,a+1);j.push(e);s.push(e)}b=r(da/b);for(a=0;a<s.length;a++){var d=w*2/b;e=s[a];for(var i=0;i<b;i++){var g=new y(false),f=c.a(R(d*i),S(d*i),e.cpos[2]);g.cpos=c.add(e.cpos,
c.sc(f,(e.rad+g.rad)*1.5));g.ppos=c.cn(g.cpos);j.push(g);e.cto.push(g);g.cto.push(e)}a!==0&&e.cto.push(s[a-1])}}function ea(){x=false;fa.fadeOut(function(){D=0;Q()})}var c={ignited:false,sT:function(){c.sT=typeof Float32Array!=="undefined"?Float32Array:Array;c.ignited=true},a:function(a,b,e){c.ignited===false&&c.sT();var d=new c.sT(3);d[0]=a;d[1]=b;d[2]=e;return d},add:function(a,b){return c.a(a[0]+b[0],a[1]+b[1],a[2]+b[2])},sub:function(a,b){return c.a(a[0]-b[0],a[1]-b[1],a[2]-b[2])},norm:function(a){var b=
a[0],e=a[1];a=a[2];var d=Math.sqrt(b*b+e*e+a*a);if(d){if(d==1)return c.a(b,e,a)}else return c.a(0,0,0);d=1/d;return c.a(b*d,e*d,a*d)},len:function(a){var b=a[0],e=a[1];a=a[2];return Math.sqrt(b*b+e*e+a*a)},dot:function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},sc:function(a,b){return c.a(a[0]*b,a[1]*b,a[2]*b)},cn:function(a){return c.a(a[0],a[1],a[2])}};y.prototype={setPos:function(a){this.cpos=a;this.ppos=c.cn(a)},setRad:function(a){this.rad=a;this.rad2=this.rad*this.rad;this.res=T(v(),this.rad*
0.01);this.invMass=1/this.rad;this.eji=T((35-this.rad)*20,200);this.nej=v()*this.eji},emitPackets:function(){this.nej++;if(this.nej>=this.eji){this.nej=0;if(this.tto.length===0)return false;this.tto.sort(function(k,n){return k.rad-n.rad});for(var a=r(this.rad/2),b=w*2/a,e=this.tto.length,d=r(this.cnes)<$?this.pstr*-1:this.pstr,i=0;i<a;i++){var g=new la(this,this.tto[i%e],d);g.acl[0]=R(b*1)*1E3;g.acl[1]=S(b*1)*1E3;g.acl[2]=0;this.acl=c.add(this.acl,c.sc(g.acl,-0.1));var f=c.a(R(b*i)*this.rad,S(b*i)*
this.rad,0);g.cpos=c.add(g.cpos,f);g.ppos=c.add(g.ppos,f);p.push(g)}}}};var F=document,A=l("#sta"),na=A[0],fa=l("#st"),E=l("#ls"),N=l("#ws"),ga=l("#eg"),J=l("#bst"),C=l("#msg"),z=l(window),ha=0,M=false,m=[z.width(),z.height(),1E3],ia={min:[0,0,0],max:[0,0,0]},U=c.a(1,1,1),B=c.a(0,0,0),o=1,h=na.getContext("2d"),v=Math.random,da=30*v()+5,j=[],s=[],p=[],t=false,q=5,H=0,P=+new Date,I=0,aa=0,$=75,K=+new Date,ja=false,x=true,V=false,D=0,ba=[{name:"Wait for it...",hint:"One may be larger, but timing is more important.",
boosts:1,init:function(){var a=new y(false),b=new y(false);a.setRad(50);a.setPos(c.a(0,0,0));a.res=0.01;a.cnes=0;a.pstr=2;a.eji=100;a.nej=75;b.setRad(15);b.setPos(c.a(-200,90,0));b.res=0.9;b.cnes=10;b.pstr=90;b.nej=0;j=[a,b]}}],O=[],R=Math.cos,S=Math.sin,T=Math.max,r=Math.floor,ka=Math.round,w=Math.PI;Y();ca();ha=setInterval(function(){for(var a=0;a<j.length;a++){var b=j[a];b.emitPackets();b.acl=c.add(b.acl,c.sc(c.sub(b.cpos,c.a(0,0,0)),-0.1));var e=c.cn(b.cpos),d=c.add(c.sub(b.cpos,b.ppos),c.sc(b.acl,
9.0E-4));b.cpos=c.add(d,b.cpos);b.ppos=c.add(c.sc(d,0.01),e);b.acl=c.a(0,0,0);b=b;b.cpos[2]=0;b.ppos[2]=0}for(a=0;a<p.length;a++){b=p[a];e=c.cn(b.cpos);d=c.sc(c.norm(c.sub(b.tnode.cpos,b.cpos)),b.tnode.rad*100);b.acl=c.add(b.acl,d);d=c.add(c.sub(b.cpos,b.ppos),c.sc(b.acl,9.0E-4));b.cpos=c.add(d,b.cpos);b.ppos=c.add(c.sc(d,0.1),e);b.acl=c.a(0,0,0);b=b;b.cpos[2]=0;b.ppos[2]=0}a:for(d=0;d<j.length;d++){a=j[d];for(var i=0;i<j.length;i++){b=j[i];if(a!=b){e=c.sub(a.cpos,b.cpos);var g=a.rad+b.rad,f=c.dot(e,
e);if(!(f>=g*g)){d=a.invMass+b.invMass;f=Math.sqrt(f);e[0]/=f;e[1]/=f;e[2]/=f;b.cpos=c.sub(b.cpos,c.sc(e,f*b.invMass));a.cpos=c.add(a.cpos,c.sc(e,f*a.invMass));f=c.sub(a.cpos,a.ppos);i=c.sub(b.cpos,b.ppos);f=c.sub(f,i);e=c.sc(e,c.dot(f,e));e=c.sub(f,e);e[0]/=d;e[1]/=d;e[2]/=d;a.cpos=c.sub(a.cpos,c.sc(e,1*a.invMass));b.cpos=c.add(b.cpos,c.sc(e,1*b.invMass));break a}}}}a=[];for(b=0;b<p.length;b++){e=p[b];d=e.tnode;f=c.sub(e.cpos,d.cpos);if(c.dot(f,f)>=(e.rad+d.rad)*(e.rad+d.rad))a.push(e);else{d.cnes+=
e.cnes*(1-d.res);d.cnes=d.cnes<=0?0:d.cnes;d.acl=c.add(d.acl,c.sc(c.sub(e.cpos,e.ppos),10));I+=1}}p=a;a=[];b=false;e=0;var k=true;for(d=0;d<j.length;d++){f=j[d];f.tto=[];for(i=0;i<j.length;i++){g=j[i];if(f!==g){for(k=0;k<a.length;k++){var n=a[k];if(n[0]===f&&n[1]===g||n[0]===g&&n[1]===f)b=true;n[0]===g&&n[1]===f&&n[2]===true&&f.tto.push(g)}if(b===true)b=false;else{k=true;n=c.sub(g.cpos,f.cpos);var G=c.len(n);n=c.sc(n,1/G);for(G=0;G<j.length;G++){var u=j[G];if(!(f===u||g===u)){var W=c.sub(u.cpos,f.cpos),
X=c.dot(W,n);if(!(X<0)){u=u.rad*u.rad-c.dot(W,W)+X*X;e++;if(!(u<0)){k=false;break}}}}if(k===true){f.tto.push(g);a.push([f,g,true])}else a.push([f,g,false])}}}}a=c.a(Infinity,Infinity,0);b=c.a(-Infinity,-Infinity,0);for(e=0;e<j.length;e++){d=j[e];if(d.cpos[0]-d.rad*4<a[0])a[0]=d.cpos[0]-d.rad*4;if(d.cpos[1]-d.rad*4<a[1])a[1]=d.cpos[1]-d.rad*4;if(d.cpos[0]+d.rad*4>b[0])b[0]=d.cpos[0]+d.rad*4;if(d.cpos[1]+d.rad*4>b[1])b[1]=d.cpos[1]+d.rad*4}ia.min=a;ia.max=b;U=c.sub(b,a);B=c.sc(c.add(b,a),0.5);o=Math.abs(Math.min(m[0]/
U[0],m[1]/U[1]));x===false&&ma();h.fillStyle="#000000";h.fillRect(0,0,m[0],m[1]);h.globalAlpha=x===true?0.1:h.globalAlpha<1?h.globalAlpha+0.01:1;for(a=0;a<j.length;a++){b=j[a];e="rgba("+ka((100-b.cnes)*0.01*255)+","+ka(b.cnes*0.01*255)+",0,1)";d=L(b.cpos);r(b.cnes);if(V===true){h.save();h.strokeStyle="rgba(51,153,0,0.5)";h.beginPath();for(f=0;f<b.tto.length;f++){i=L(b.tto[f].cpos);h.moveTo(d[0],d[1]);h.lineTo(i[0],i[1])}h.stroke();h.restore()}h.save();h.fillStyle=e;h.beginPath();h.arc(d[0],d[1],b.rad*
(1-b.cpos[2]/m[2])*o,0,w*2,false);h.fill();h.restore();h.save();h.strokeStyle="rgba(204,204,204,0.6)";h.lineWidth=T(r(b.pstr*b.pstr*0.0050),4)*o;h.beginPath();h.arc(d[0],d[1],b.rad*(1-b.cpos[2]/m[2])*o,0,w*2*(b.nej/b.eji),false);h.stroke();h.restore();h.save();h.strokeStyle="#CCCCCC";h.beginPath();h.arc(d[0],d[1],b.res*100*(1-b.cpos[2]/m[2])*o,0,w*2,false);h.stroke();h.restore()}h.save();h.fillStyle="#3399FF";for(a=h.lineWidth=0;a<p.length;a++){b=p[a];e=L(b.cpos);h.beginPath();h.arc(e[0],e[1],b.rad*
(1-b.cpos[2]/m[2]),0,w*2,false);h.fill()}h.restore()},33);l(F).bind("mousedown",function(a){var b=+new Date,e=9.0E200;a=Z(c.a(a.pageX,a.pageY,0));for(var d=0;d<j.length;d++){var i=j[d],g=c.len(c.sub(a,i.cpos));if(g<e&&g<=i.rad*1.5){t=j[d];e=g}}if(K&&b-K>90&&b-K<300){if(t!==false&&q>=1){t.cnes+=75;q-=1;H+=1;J.text("BOOSTS: "+q)}q<=0&&C.text("Boosts depleted. Press 'r' to restart this level, unless... you're awesome?")}K=b});l(F).bind("mouseup",function(){t=false;x===true&&ea()});l(F).bind("mousemove",
function(a){a=Z(c.a(a.pageX,a.pageY,0));if(t!==false){t.cpos=a;t.ppos=a}});l(F).bind("keydown",function(a){if(a.keyCode===27){clearInterval(ha);fa.hide();N.hide();E.hide();J.hide();C.hide();for(var b=0,e=0,d=0,i=0,g=0,f=O,k=0;k<f.length;k++){b+=f[k].bus;e+=f[k].ccount;d+=f[k].time;i+=f[k].tanti;g+=f[k].rsts}ga.find("ul").html("<li>"+O.length+" rounds completed in "+d/1E3+" seconds</li><li>"+e+" cells saved from a horrible, painful death</li><li>You used "+b+(b==1?" boost ":" boosts ")+"of antibiotics</li><li>You fought with an army of "+
i+" antibodies</li><li>You had to retry "+g+(g==1?" time":" times")+"</li>");A.fadeTo(300,0.2);ga.fadeIn()}if(a.keyCode===68)ja=true;if(a.keyCode===32)V=true});l(F).bind("keyup",function(a){if(x===true&&a.keyCode===32)ea();else if(x===false){if(a.keyCode===68)ja=false;if(a.keyCode===32)V=false;if(a.keyCode===82){aa+=1;Q()}}});z.bind("resize",Y)})})(jQuery);
