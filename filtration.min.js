$(function(){function v(a){var b=Math.random();this.q(30*b+15);this.G=a;this.e=c.c(0,0,0);this.a=c.c(0,0,0);this.d=c.c(0,0,0);this.p=[];this.f=99*Math.random()+1;this.g=[];this.k=99*b+1}function Z(a,b,e){this.b=2;this.f=e;this.e=c.h(a.e);this.a=c.h(a.a);this.d=c.h(a.d);this.I=a;this.s=b}function aa(){f.fillStyle="#000000";f.fillRect(0,0,k[0],k[1]);f.globalAlpha=s===true?0.1:f.globalAlpha<1?f.globalAlpha+0.01:1;if(F===true){var a=t(z.min),b=c.scale(A,m),e=t(z.max);f.save();f.lineWidth=1;f.strokeStyle=
"#CCCCCC";f.strokeRect(a[0],a[1],b[0],b[1]);f.beginPath();f.arc(e[0],e[1],10,0,Math.PI*2,false);f.fill();f.beginPath();f.arc(a[0],a[1],10,0,Math.PI*2,false);f.fill();f.restore();f.save();f.fillStyle="#FFFFFF";a=t(c.c(0,0,0));f.beginPath();f.arc(a[0],a[1],5,0,Math.PI*2,false);f.fill();f.restore();f.save();f.fillStyle="#FFFFFF";f.fillText(MM(60)[0],100,20);f.restore()}i.sort(function(n,l){return n.a[2]-l.a[2]});for(a=0;a<i.length;a++){var d=i[a],j="rgba("+Math.round((100-d.f)*0.01*255)+","+Math.round(d.f*
0.01*255)+",0,1)";b=t(d.a);e=Math.floor(d.f);if(G===true){f.save();f.strokeStyle="rgba(51,153,0,0.5)";f.beginPath();for(var g=0;g<d.g.length;g++){var h=t(d.g[g].a);f.moveTo(b[0],b[1]);f.lineTo(h[0],h[1])}f.stroke();f.restore()}f.save();f.fillStyle=j;f.beginPath();f.arc(b[0],b[1],d.b*(1-d.a[2]/k[2])*m,0,Math.PI*2,false);f.fill();f.restore();f.save();f.strokeStyle="rgba(204,204,204,0.6)";f.lineWidth=Math.max(Math.floor(d.k*d.k*0.0050),4)*m;f.beginPath();f.arc(b[0],b[1],d.b*(1-d.a[2]/k[2])*m,0,Math.PI*
2*(d.j/d.n),false);f.stroke();f.restore();f.save();f.strokeStyle="#CCCCCC";f.beginPath();f.arc(b[0],b[1],d.o*100*(1-d.a[2]/k[2])*m,0,Math.PI*2,false);f.stroke();f.restore();f.save();f.fillStyle="#000000";f.font="bold "+Math.floor(14*m)+"px arial";d=f.measureText(e);f.fillText(e,b[0]-d.width/2,b[1]+4*m);f.restore()}f.fillStyle="#3399FF";for(a=f.lineWidth=0;a<o.length;a++){b=o[a];e=t(b.a);f.beginPath();f.arc(e[0],e[1],b.b*(1-b.a[2]/k[2]),0,Math.PI*2,false);f.fill()}f.lineWidth=1;if(ba===true){f.save();
f.font="bold 32px Helvetica, Arial, sans-serif";a="BOOSTERS Remaining: "+p;b=f.measureText(a).width;f.fillText(a,k[0]-b-10,k[1]-10);f.restore()}if(ca===true){f.save();f.font="bold 52px 'Trebuchet MS', Helvetica, Arial, sans-serif";f.fillText("WIN",10,70);f.font="bold 28px 'Georgia', Helvetica, Arial, sans-serif";f.fillText("You purified the infection! Onto the next in 5 seconds...",10,100);f.restore()}}function O(){k=[B.width(),B.height(),1E3];dimh=c.scale(k,0.5);da.D({width:k[0],height:k[1]})}function t(a){return c.c((a[0]-
w[0])*m+dimh[0],(a[1]-w[1])*m+dimh[1],0)}function P(a){return c.c(a[0]/m+w[0]-dimh[0]/m,a[1]/m+w[1]-dimh[1]/m,0)}function ea(){for(var a=true,b=0;b<i.length;b++)if(i[b].f<Q)a=false;if(a===true&&H===false){H=true;R.A();S[x]={J:+new Date-I,F:C};setTimeout(function(){R.t(function(){H=false;x++;J()})},5E3)}}function J(){i=[];u=[];o=[];C=0;if(x>=T.length){console.log("ENDGAME");U()}else{var a=T[x];p=a.w;K.text("BOOSTS: "+p);L.text("");D.find("h1").text(a.name);D.find("p").text(a.B);D.A(400);console.log("lvl fade in");
setTimeout(function(){D.t(400);console.log("lvl fade out")},5E3);a.C();I=+new Date}}function U(){i=[];u=[];o=[];C=0;p=5;L.text("");K.text("BOOSTS: "+p);I=+new Date;for(var a=Math.floor(V/4),b=0;b<a;b++){var e=new v(true),d=c.c(Math.floor(k[0]/(a+1)),Math.floor(k[1]/(a+1)*Math.random()),0);e.a=c.scale(d,b+1);e.e=c.scale(d,b+1);i.push(e);u.push(e)}a=Math.floor(V/a);for(b=0;b<u.length;b++){e=u[b];d=Math.PI*2/a;for(var j=0;j<a;j++){var g=new v(false),h=c.c(Math.cos(d*j),Math.sin(d*j),e.a[2]);g.a=c.add(e.a,
c.scale(h,(e.b+g.b)*1.5));g.e=c.h(g.a);i.push(g);e.p.push(g);g.p.push(e)}b!==0&&e.p.push(u[b-1])}}function W(){s=false;fa.t(function(){x=0;J()})}var c={u:false,r:function(){c.r=typeof Float32Array!=="undefined"?Float32Array:Array;c.u=true},c:function(a,b,e){c.u===false&&c.r();var d=new c.r(3);d[0]=a;d[1]=b;d[2]=e;return d},add:function(a,b){return c.c(a[0]+b[0],a[1]+b[1],a[2]+b[2])},sub:function(a,b){return c.c(a[0]-b[0],a[1]-b[1],a[2]-b[2])},normalize:function(a){var b=a[0],e=a[1];a=a[2];var d=Math.sqrt(b*
b+e*e+a*a);if(d){if(d==1)return c.c(b,e,a)}else return c.c(0,0,0);d=1/d;return c.c(b*d,e*d,a*d)},length:function(a){var b=a[0],e=a[1];a=a[2];return Math.sqrt(b*b+e*e+a*a)},m:function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},scale:function(a,b){return c.c(a[0]*b,a[1]*b,a[2]*b)},h:function(a){return c.c(a[0],a[1],a[2])}};v.prototype={v:function(a){this.a=a;this.e=c.h(a)},q:function(a){this.b=a;this.H=this.b*this.b;this.o=Math.max(Math.random(),this.b*0.01);this.i=1/this.b;this.n=Math.max((35-this.b)*
20,200);this.j=Math.random()*this.n},z:function(){this.j++;if(this.j>=this.n){this.j=0;if(this.g.length===0)return false;this.g.sort(function(n,l){return n.b-l.b});for(var a=Math.floor(this.b/2),b=Math.PI*2/a,e=this.g.length,d=Math.floor(this.f)<Q?this.k*-1:this.k,j=0;j<a;j++){var g=new Z(this,this.g[j%e],d);g.d[0]=Math.cos(b*1)*1E3;g.d[1]=Math.sin(b*1)*1E3;g.d[2]=0;this.d=c.add(this.d,c.scale(g.d,-0.1));var h=c.c(Math.cos(b*j)*this.b,Math.sin(b*j)*this.b,0);g.a=c.add(g.a,h);g.e=c.add(g.e,h);o.push(g)}}}};
var X=document.getElementById("stage"),da=$(X),fa=$("#start"),D=$("#lvlstatus"),R=$("#winstatus"),K=$("#boosts"),L=$("#msg"),B=$(window),Y=0,H=false,k=[B.width(),B.height(),1E3],z={min:[0,0,0],max:[0,0,0]},A=c.c(1,1,1),w=c.c(0,0,0),m=1,f=X.getContext("2d"),V=10*Math.random()+5,i=[],u=[],o=[],q=false,p=5,C=0,I=+new Date,Q=75,E=+new Date,F=false,s=true,G=false,ba=false,ca=false,x=0,T=[{name:"Wait for it...",B:"One may be larger, but timing is more important.",w:1,C:function(){var a=new v(false),b=new v(false);
a.q(50);a.v(c.c(0,0,0));a.o=0.01;a.f=0;a.k=2;a.n=100;a.j=75;b.q(15);b.v(c.c(-200,90,0));b.o=0.9;b.f=10;b.k=90;b.j=0;i=[a,b]}}],S=[];O();U();Y=setInterval(function(){for(var a=0;a<i.length;a++){var b=i[a];b.z();b.d=c.add(b.d,c.scale(c.sub(b.a,c.c(0,0,0)),-0.1));var e=c.h(b.a),d=c.add(c.sub(b.a,b.e),c.scale(b.d,9.0E-4));b.a=c.add(d,b.a);b.e=c.add(c.scale(d,0.01),e);b.d=c.c(0,0,0);b=b;b.a[2]=0;b.e[2]=0}for(a=0;a<o.length;a++){b=o[a];e=c.scale(c.normalize(c.sub(b.s.a,b.a)),b.s.b*100);b.d=c.add(b.d,e);
e=c.h(b.a);d=c.add(c.sub(b.a,b.e),c.scale(b.d,9.0E-4));b.a=c.add(d,b.a);b.e=c.add(c.scale(d,0.1),e);b.d=c.c(0,0,0);b=b;b.a[2]=0;b.e[2]=0}a:for(d=0;d<i.length;d++){a=i[d];for(var j=0;j<i.length;j++){b=i[j];if(a!=b){e=c.sub(a.a,b.a);var g=a.b+b.b,h=c.m(e,e);if(!(h>=g*g)){d=a.i+b.i;h=Math.sqrt(h);e[0]/=h;e[1]/=h;e[2]/=h;b.a=c.sub(b.a,c.scale(e,h*b.i));a.a=c.add(a.a,c.scale(e,h*a.i));h=c.sub(a.a,a.e);j=c.sub(b.a,b.e);h=c.sub(h,j);e=c.scale(e,c.m(h,e));e=c.sub(h,e);e[0]/=d;e[1]/=d;e[2]/=d;a.a=c.sub(a.a,
c.scale(e,1*a.i));b.a=c.add(b.a,c.scale(e,1*b.i));break a}}}}a=[];for(b=0;b<o.length;b++){e=o[b];d=e.s;h=c.sub(e.a,d.a);if(c.m(h,h)>=(e.b+d.b)*(e.b+d.b))a.push(e);else{d.f+=e.f*(1-d.o);d.f=d.f<=0?0:d.f;d.d=c.add(d.d,c.scale(c.sub(e.a,e.e),10))}}o=a;a=[];b=false;e=0;var n=true;for(d=0;d<i.length;d++){h=i[d];h.g=[];for(j=0;j<i.length;j++){g=i[j];if(h!==g){for(n=0;n<a.length;n++){var l=a[n];if(l[0]===h&&l[1]===g||l[0]===g&&l[1]===h)b=true;l[0]===g&&l[1]===h&&l[2]===true&&h.g.push(g)}if(b===true)b=false;
else{n=true;l=c.sub(g.a,h.a);var y=c.length(l);l=c.scale(l,1/y);for(y=0;y<i.length;y++){var r=i[y];if(!(h===r||g===r)){var M=c.sub(r.a,h.a),N=c.m(M,l);if(!(N<0)){r=r.b*r.b-c.m(M,M)+N*N;e++;if(!(r<0)){n=false;break}}}}if(n===true){h.g.push(g);a.push([h,g,true])}else a.push([h,g,false])}}}}a=c.c(Infinity,Infinity,0);b=c.c(-Infinity,-Infinity,0);for(e=0;e<i.length;e++){d=i[e];if(d.a[0]-d.b*4<a[0])a[0]=d.a[0]-d.b*4;if(d.a[1]-d.b*4<a[1])a[1]=d.a[1]-d.b*4;if(d.a[0]+d.b*4>b[0])b[0]=d.a[0]+d.b*4;if(d.a[1]+
d.b*4>b[1])b[1]=d.a[1]+d.b*4}z.min=a;z.max=b;A=c.sub(b,a);w=c.scale(c.add(b,a),0.5);m=Math.abs(Math.min(k[0]/A[0],k[1]/A[1]));s===false&&ea();aa()},33);$(document).l("mousedown",function(a){var b=+new Date,e=9.0E200,d=P(c.c(a.pageX,a.pageY,0));console.log(a,d);for(a=0;a<i.length;a++){var j=i[a],g=c.length(c.sub(d,j.a));if(g<e&&g<=j.b*1.5){q=i[a];e=g}}console.log(q);if(E&&b-E>120&&b-E<300){if(q!==false&&p>=1){q.f+=75;p-=1;C+=1;K.text("BOOSTS: "+p)}p<=0&&L.text("Boosts depleted. Press 'r' to restart this level, unless... you're awesome?");
console.log("DOUBLE CLICK: CLEANESS REINFORCED!")}E=b});$(document).l("mouseup",function(){q=false;s===true&&W()});$(document).l("mousemove",function(a){a=P(c.c(a.pageX,a.pageY,0));if(q!==false){q.a=a;q.e=a;console.log("MOVING",a)}});$(document).l("keydown",function(a){if(a.keyCode==27){clearInterval(Y);console.log("execution stopped",S)}if(a.keyCode==68)F=true;if(a.keyCode==32)G=true});$(document).l("keyup",function(a){console.log(a.keyCode);if(s===true&&a.keyCode===32)W();else if(s===false){if(a.keyCode==
68)F=false;if(a.keyCode==32)G=false;a.keyCode==82&&J()}});$(window).l("resize",O)});
