(function(l){l(function(){function y(a){var b=v();this.setRad(30*b+15);this.ist=a;this.ppos=c.a(0,0,0);this.cpos=c.a(0,0,0);this.acl=c.a(0,0,0);this.cto=[];this.cnes=99*v()+1;this.tto=[];this.pstr=99*b+1}function la(a,b,e){this.rad=2;this.cnes=e;this.ppos=c.cn(a.ppos);this.cpos=c.cn(a.cpos);this.acl=c.cn(a.acl);this.snode=a;this.tnode=b}function Y(){m=[z.width(),z.height(),1E3];dimh=c.sc(m,0.5);A.attr({width:m[0],height:m[1]})}function L(a){return c.a((a[0]-B[0])*o+dimh[0],(a[1]-B[1])*o+dimh[1],0)}
function Z(a){return c.a(a[0]/o+B[0]-dimh[0]/o,a[1]/o+B[1]-dimh[1]/o,0)}function ma(){for(var a=true,b=0;b<j.length;b++)if(j[b].cnes<$)a=false;if(a===true&&M===false){M=true;N.fadeIn();A.fadeTo(300,0.2);C.text("");O[D]={time:+new Date-P,bus:H,ccount:j.length+s.length,tanti:I,rsts:aa};setTimeout(function(){N.fadeOut(function(){M=false;A.fadeTo(300,1);D++;Q()})},5E3)}}function Q(){j=[];s=[];p=[];I=H=0;if(D>=ba.length)ca();else{var a=ba[D];r=a.boosts;J.text("BOOSTS: "+r);C.text("Press the ESC key to stop at any time.");
E.find("h1").text(a.name);E.find("p").text(a.hint);E.fadeIn(400);setTimeout(function(){E.fadeOut(400)},5E3);a.init();P=+new Date}}function ca(){j=[];s=[];p=[];I=H=0;r=5;C.text("");J.text("BOOSTS: "+r);P=+new Date;for(var a=0,b=q(da/4),e;a<b;a++){e=new y(true);sec=c.a(q(m[0]/(b+1)),q(m[1]/(b+1)*v()),0);e.cpos=c.sc(sec,a+1);e.ppos=c.sc(sec,a+1);j.push(e);s.push(e)}b=q(da/b);for(a=0;a<s.length;a++){var d=w*2/b;e=s[a];for(var i=0;i<b;i++){var h=new y(false),g=c.a(R(d*i),S(d*i),e.cpos[2]);h.cpos=c.add(e.cpos,
c.sc(g,(e.rad+h.rad)*1.5));h.ppos=c.cn(h.cpos);j.push(h);e.cto.push(h);h.cto.push(e)}a!==0&&e.cto.push(s[a-1])}}function ea(){x=false;fa.fadeOut(function(){D=0;Q()})}var c={ignited:false,sT:function(){c.sT=typeof Float32Array!=="undefined"?Float32Array:Array;c.ignited=true},a:function(a,b,e){c.ignited===false&&c.sT();var d=new c.sT(3);d[0]=a;d[1]=b;d[2]=e;return d},add:function(a,b){return c.a(a[0]+b[0],a[1]+b[1],a[2]+b[2])},sub:function(a,b){return c.a(a[0]-b[0],a[1]-b[1],a[2]-b[2])},norm:function(a){var b=
a[0],e=a[1];a=a[2];var d=Math.sqrt(b*b+e*e+a*a);if(d){if(d==1)return c.a(b,e,a)}else return c.a(0,0,0);d=1/d;return c.a(b*d,e*d,a*d)},len:function(a){var b=a[0],e=a[1];a=a[2];return Math.sqrt(b*b+e*e+a*a)},dot:function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},sc:function(a,b){return c.a(a[0]*b,a[1]*b,a[2]*b)},cn:function(a){return c.a(a[0],a[1],a[2])}};y.prototype={setPos:function(a){this.cpos=a;this.ppos=c.cn(a)},setRad:function(a){this.rad=a;this.rad2=this.rad*this.rad;this.res=T(v(),this.rad*
0.01);this.invMass=1/this.rad;this.eji=T((35-this.rad)*20,200);this.nej=v()*this.eji},emitPackets:function(){this.nej++;if(this.nej>=this.eji){this.nej=0;if(this.tto.length===0)return false;this.tto.sort(function(k,n){return k.rad-n.rad});for(var a=q(this.rad/2),b=w*2/a,e=this.tto.length,d=q(this.cnes)<$?this.pstr*-1:this.pstr,i=0;i<a;i++){var h=new la(this,this.tto[i%e],d);h.acl[0]=R(b*1)*1E3;h.acl[1]=S(b*1)*1E3;h.acl[2]=0;this.acl=c.add(this.acl,c.sc(h.acl,-0.1));var g=c.a(R(b*i)*this.rad,S(b*i)*
this.rad,0);h.cpos=c.add(h.cpos,g);h.ppos=c.add(h.ppos,g);p.push(h)}}}};var F=document,A=l("#sta"),na=A[0],fa=l("#st"),E=l("#ls"),N=l("#ws"),ga=l("#eg"),J=l("#bst"),C=l("#msg"),z=l(window),ha=0,M=false,m=[z.width(),z.height(),1E3],ia={min:[0,0,0],max:[0,0,0]},U=c.a(1,1,1),B=c.a(0,0,0),o=1,f=na.getContext("2d"),v=Math.random,da=30*v()+5,j=[],s=[],p=[],t=false,r=5,H=0,P=+new Date,I=0,aa=0,$=75,K=+new Date,ja=false,x=true,V=false,D=0,ba=[{name:"Wait for it...",hint:"One may be larger, but timing is more important.",
boosts:1,init:function(){var a=new y(false),b=new y(false);a.setRad(50);a.setPos(c.a(0,0,0));a.res=0.01;a.cnes=0;a.pstr=2;a.eji=100;a.nej=75;b.setRad(15);b.setPos(c.a(-200,90,0));b.res=0.9;b.cnes=10;b.pstr=90;b.nej=0;j=[a,b]}}],O=[],R=Math.cos,S=Math.sin,T=Math.max,q=Math.floor,ka=Math.round,w=Math.PI;Y();ca();ha=setInterval(function(){for(var a=0;a<j.length;a++){var b=j[a];b.emitPackets();b.acl=c.add(b.acl,c.sc(c.sub(b.cpos,c.a(0,0,0)),-0.1));var e=c.cn(b.cpos),d=c.add(c.sub(b.cpos,b.ppos),c.sc(b.acl,
9.0E-4));b.cpos=c.add(d,b.cpos);b.ppos=c.add(c.sc(d,0.01),e);b.acl=c.a(0,0,0);b=b;b.cpos[2]=0;b.ppos[2]=0}for(a=0;a<p.length;a++){b=p[a];e=c.cn(b.cpos);d=c.sc(c.norm(c.sub(b.tnode.cpos,b.cpos)),b.tnode.rad*100);b.acl=c.add(b.acl,d);d=c.add(c.sub(b.cpos,b.ppos),c.sc(b.acl,9.0E-4));b.cpos=c.add(d,b.cpos);b.ppos=c.add(c.sc(d,0.1),e);b.acl=c.a(0,0,0);b=b;b.cpos[2]=0;b.ppos[2]=0}a:for(d=0;d<j.length;d++){a=j[d];for(var i=0;i<j.length;i++){b=j[i];if(a!=b){e=c.sub(a.cpos,b.cpos);var h=a.rad+b.rad,g=c.dot(e,
e);if(!(g>=h*h)){d=a.invMass+b.invMass;g=Math.sqrt(g);e[0]/=g;e[1]/=g;e[2]/=g;b.cpos=c.sub(b.cpos,c.sc(e,g*b.invMass));a.cpos=c.add(a.cpos,c.sc(e,g*a.invMass));g=c.sub(a.cpos,a.ppos);i=c.sub(b.cpos,b.ppos);g=c.sub(g,i);e=c.sc(e,c.dot(g,e));e=c.sub(g,e);e[0]/=d;e[1]/=d;e[2]/=d;a.cpos=c.sub(a.cpos,c.sc(e,1*a.invMass));b.cpos=c.add(b.cpos,c.sc(e,1*b.invMass));break a}}}}a=[];for(b=0;b<p.length;b++){e=p[b];d=e.tnode;g=c.sub(e.cpos,d.cpos);if(c.dot(g,g)>=(e.rad+d.rad)*(e.rad+d.rad))a.push(e);else{d.cnes+=
e.cnes*(1-d.res);d.cnes=d.cnes<=0?0:d.cnes;d.acl=c.add(d.acl,c.sc(c.sub(e.cpos,e.ppos),10));I+=1}}p=a;a=[];b=false;e=0;var k=true;for(d=0;d<j.length;d++){g=j[d];g.tto=[];for(i=0;i<j.length;i++){h=j[i];if(g!==h){for(k=0;k<a.length;k++){var n=a[k];if(n[0]===g&&n[1]===h||n[0]===h&&n[1]===g)b=true;n[0]===h&&n[1]===g&&n[2]===true&&g.tto.push(h)}if(b===true)b=false;else{k=true;n=c.sub(h.cpos,g.cpos);var G=c.len(n);n=c.sc(n,1/G);for(G=0;G<j.length;G++){var u=j[G];if(!(g===u||h===u)){var W=c.sub(u.cpos,g.cpos),
X=c.dot(W,n);if(!(X<0)){u=u.rad*u.rad-c.dot(W,W)+X*X;e++;if(!(u<0)){k=false;break}}}}if(k===true){g.tto.push(h);a.push([g,h,true])}else a.push([g,h,false])}}}}a=c.a(Infinity,Infinity,0);b=c.a(-Infinity,-Infinity,0);for(e=0;e<j.length;e++){d=j[e];if(d.cpos[0]-d.rad*4<a[0])a[0]=d.cpos[0]-d.rad*4;if(d.cpos[1]-d.rad*4<a[1])a[1]=d.cpos[1]-d.rad*4;if(d.cpos[0]+d.rad*4>b[0])b[0]=d.cpos[0]+d.rad*4;if(d.cpos[1]+d.rad*4>b[1])b[1]=d.cpos[1]+d.rad*4}ia.min=a;ia.max=b;U=c.sub(b,a);B=c.sc(c.add(b,a),0.5);o=Math.abs(Math.min(m[0]/
U[0],m[1]/U[1]));x===false&&ma();f.fillStyle="#000000";f.fillRect(0,0,m[0],m[1]);f.globalAlpha=x===true?0.1:f.globalAlpha<1?f.globalAlpha+0.01:1;for(a=0;a<j.length;a++){d=j[a];g="rgba("+ka((100-d.cnes)*0.01*255)+","+ka(d.cnes*0.01*255)+",0,1)";b=L(d.cpos);e=q(d.cnes);if(V===true){f.save();f.strokeStyle="rgba(51,153,0,0.5)";f.beginPath();for(i=0;i<d.tto.length;i++){h=L(d.tto[i].cpos);f.moveTo(b[0],b[1]);f.lineTo(h[0],h[1])}f.stroke();f.restore()}f.save();f.fillStyle=g;f.beginPath();f.arc(b[0],b[1],
d.rad*(1-d.cpos[2]/m[2])*o,0,w*2,false);f.fill();f.restore();f.save();f.strokeStyle="rgba(204,204,204,0.6)";f.lineWidth=T(q(d.pstr*d.pstr*0.0050),4)*o;f.beginPath();f.arc(b[0],b[1],d.rad*(1-d.cpos[2]/m[2])*o,0,w*2*(d.nej/d.eji),false);f.stroke();f.restore();f.save();f.strokeStyle="#CCCCCC";f.beginPath();f.arc(b[0],b[1],d.res*100*(1-d.cpos[2]/m[2])*o,0,w*2,false);f.stroke();f.restore();f.save();f.fillStyle="#000000";f.font="bold "+q(14*o)+"px arial";d=f.measureText(e);f.fillText(e,b[0]-d.width/2,b[1]+
4*o);f.restore()}f.save();f.fillStyle="#3399FF";for(a=f.lineWidth=0;a<p.length;a++){b=p[a];e=L(b.cpos);f.beginPath();f.arc(e[0],e[1],b.rad*(1-b.cpos[2]/m[2]),0,w*2,false);f.fill()}f.restore()},33);l(F).bind("mousedown",function(a){var b=+new Date,e=9.0E200;a=Z(c.a(a.pageX,a.pageY,0));for(var d=0;d<j.length;d++){var i=j[d],h=c.len(c.sub(a,i.cpos));if(h<e&&h<=i.rad*1.5){t=j[d];e=h}}if(K&&b-K>90&&b-K<300){if(t!==false&&r>=1){t.cnes+=75;r-=1;H+=1;J.text("BOOSTS: "+r)}r<=0&&C.text("Boosts depleted. Press 'r' to restart this level, unless... you're awesome?")}K=
b});l(F).bind("mouseup",function(){t=false;x===true&&ea()});l(F).bind("mousemove",function(a){a=Z(c.a(a.pageX,a.pageY,0));if(t!==false){t.cpos=a;t.ppos=a}});l(F).bind("keydown",function(a){if(a.keyCode===27){clearInterval(ha);fa.hide();N.hide();E.hide();J.hide();C.hide();for(var b=0,e=0,d=0,i=0,h=0,g=O,k=0;k<g.length;k++){b+=g[k].bus;e+=g[k].ccount;d+=g[k].time;i+=g[k].tanti;h+=g[k].rsts}ga.find("ul").html("<li>"+O.length+" rounds completed in "+d/1E3+" seconds</li><li>"+e+" cells saved from a horrible, painful death</li><li>You used "+
b+(b==1?" boost ":" boosts ")+"of antibiotics</li><li>You fought with an army of "+i+" antibodies</li><li>You had to retry "+h+(h==1?" time":" times")+"</li>");A.fadeTo(300,0.2);ga.fadeIn()}if(a.keyCode===68)ja=true;if(a.keyCode===32)V=true});l(F).bind("keyup",function(a){if(x===true&&a.keyCode===32)ea();else if(x===false){if(a.keyCode===68)ja=false;if(a.keyCode===32)V=false;if(a.keyCode===82){aa+=1;Q()}}});z.bind("resize",Y)})})(jQuery);
